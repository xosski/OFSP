"""
WRAITH Engine - Deep Process, Memory, and File Purger
Author: Quellaran // Specter
"""
import os
import psutil
import shutil
import ctypes
import winreg
import logging
from pathlib import Path

logging.basicConfig(level=logging.INFO, format='[%(levelname)s] %(message)s')


class WraithEngine:
    def __init__(self, mode="aggressive"):
        self.mode = mode.lower()
        self.logger = logging.getLogger("WRAITH")

    def resolve_process(self, name=None, pid=None):
        for proc in psutil.process_iter(['pid', 'name', 'exe', 'cmdline']):
            try:
                if pid and proc.pid == pid:
                    return proc
                if name and proc.info['name'].lower() == name.lower():
                    return proc
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                continue
        return None

    def purge(self, name=None, pid=None):
        proc = self.resolve_process(name, pid)
        if not proc:
            self.logger.warning("Target process not found.")
            return

        self.logger.info(f"Targeting: {proc.name()} (PID {proc.pid})")

        # Step 1: Kill Process
        try:
            proc.kill()
            self.logger.info("Process terminated.")
        except Exception as e:
            self.logger.error(f"Failed to kill process: {e}")

        # Step 2: Delete Executable
        try:
            exe = proc.exe()
            if os.path.exists(exe):
                self.secure_delete(exe)
        except Exception as e:
            self.logger.error(f"Error deleting exe: {e}")

        # Step 3: Delete Open Files
        try:
            for f in proc.open_files():
                self.secure_delete(f.path)
        except Exception:
            pass

        # Step 4: Registry Cleanup
        self.clean_registry(proc.name())

        self.logger.info("PURGE COMPLETE.")

    def secure_delete(self, path):
        try:
            if os.path.isdir(path):
                shutil.rmtree(path, ignore_errors=True)
                self.logger.info(f"Directory removed: {path}")
            elif os.path.isfile(path):
                with open(path, 'ba+', buffering=0) as f:
                    length = f.tell()
                    for _ in range(3):
                        f.seek(0)
                        f.write(os.urandom(length))
                os.remove(path)
                self.logger.info(f"File shredded: {path}")
        except Exception as e:
            self.logger.warning(f"Secure delete failed for {path}: {e}")

    def clean_registry(self, process_name):
        keys = [
            r"Software\Microsoft\Windows\CurrentVersion\Run",
            r"Software\Microsoft\Windows\CurrentVersion\RunOnce",
            r"System\CurrentControlSet\Services"
        ]
        hives = [winreg.HKEY_LOCAL_MACHINE, winreg.HKEY_CURRENT_USER]
        for hive in hives:
            for key_path in keys:
                try:
                    with winreg.OpenKey(hive, key_path, 0, winreg.KEY_ALL_ACCESS) as key:
                        i = 0
                        while True:
                            try:
                                value = winreg.EnumValue(key, i)
                                if process_name.lower() in str(value).lower():
                                    winreg.DeleteValue(key, value[0])
                                    self.logger.info(f"Registry cleaned: {key_path} -> {value[0]}")
                                else:
                                    i += 1
                            except OSError:
                                break
                except Exception:
                    continue


if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(description="WRAITH Process Purger")
    parser.add_argument('--target', help='Process name (e.g., evil.exe)')
    parser.add_argument('--pid', type=int, help='PID of process')
    parser.add_argument('--mode', default='aggressive', help='Mode: aggressive | stealth')

    args = parser.parse_args()

    engine = WraithEngine(mode=args.mode)
    engine.purge(name=args.target, pid=args.pid)
